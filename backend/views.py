import json
import logging
from datetime import datetime

from django.http import JsonResponse
from django.conf import settings
from django.forms.models import model_to_dict

import django_rq
import requests
import jieba.posseg
import pandas as pd

from .models import Schedule, HandledJob
from .tasks import run
from . import recommend

logger = logging.getLogger('django')


# 处理求职者数据
def get_recommend(edu, dec, exp):
    seglist = jieba.posseg.cut(dec)
    vec = recommend.dec.copy()
    kword = set()
    for seg in seglist:
        word = "".join(seg.word).strip().lower()
        if word == 'ai': word = '人工智能'
        if word == '后台': word = '后端'
        if word == '分析员': word = '分析师'
        if word == '美工': word = 'ui'
        if word == 'nlp': word = '自然语言'
        if word in recommend.dec_keyword:
            kword.add(word)
            vec[word] = [1]
    ans = pd.DataFrame(vec)
    worker = list(kword)
    pre = recommend.RFCModel.predict(ans[recommend.dec_keyword][0:])
    kind = str(pre[0])
    ans = {}
    try:
        hj = HandledJob.objects.filter(job_class=kind)
        for job in hj:
            if job.job_dec is None: continue
            decword = "".join(job.job_dec).split()
            ans[job.id] = recommend.DocModel.n_similarity(worker, decword)
    except Exception as err:
        logger.debug("get recommend ERROR: ")
        print(err)
    p = sorted(ans.items(), key=lambda ans: ans[1], reverse=True)
    cas = 0
    response = []
    for (id, pi) in p:
        if cas > 10: break
        response.append([id, pi])
        cas += 1
    return response


def login(request):
    if request.method == 'POST':
        request_json = json.loads(request.body.decode('utf-8'))
        if 'username' in request_json \
                and 'password' in request_json \
                and request_json['username'] == settings.ADMIN_USERNAME \
                and request_json['password'] == settings.ADMIN_PASSWORD:
            response = {
                'error': 0,
                'message': 'auth success'
            }
            return JsonResponse(response)
        response = {
            'error': -1,
            'message': 'auth failed'
        }
        return JsonResponse(response)


def schedule(request):
    # get schedule status
    if request.method == 'GET':
        try:
            latest_schedule = Schedule.objects.latest('id')
        except Schedule.DoesNotExist:
            websites = ['boss', 'job51', 'liepin', 'neitui', 'zlzp']
            websites_string = ','.join(websites)
            new_schedule = Schedule(websites=websites_string)
            new_schedule.save()
            django_rq.enqueue(run, args=[websites], job_id='init')
            response = {
                'error': 1,
                'message': 'need init'
            }
            return JsonResponse(response)
        else:
            all_schedules = list(Schedule.objects.all().values())
            if latest_schedule.finish_time is None:
                response = {
                    'error': 2,
                    'message': 'latest task not finished',
                    'schedule': all_schedules
                }
                return JsonResponse(response)
            else:
                response = {
                    'error': 0,
                    'message': 'allow operation',
                    'schedule': all_schedules
                }
                return JsonResponse(response)

    # modify schedule
    if request.method == 'PUT':
        request_json = json.loads(request.body.decode('utf-8'))
        if 'websites' in request_json \
                and 'every_x_days' in request_json \
                and 'every_x_clock' in request_json:
            scheduler = django_rq.get_scheduler('default')
            scheduled_jobs = scheduler.get_jobs()
            for job in scheduled_jobs:
                scheduler.cancel(job)
            utc_now = datetime.utcnow()
            year = int(utc_now.strftime('%Y'))
            month = int(utc_now.strftime('%m'))
            day = int(utc_now.strftime('%d'))
            first_time = datetime(year, month, day, request_json['every_x_clock'])
            if first_time < utc_now:
                first_time = datetime(year, month, day + 1, request_json['every_x_clock'])
            scheduler.schedule(scheduled_time=first_time,
                               func=run,
                               args=[request_json['websites']],
                               interval=86400 * request_json['every_x_days']
                               )
            # 记录到数据库
            websites_string = ','.join(request_json['websites'])
            new_schedule = Schedule(websites=websites_string,
                                    every_x_days=request_json['every_x_days'],
                                    every_x_clock=request_json['every_x_clock'])
            new_schedule.save()
            response = {
                'error': 0,
                'message': 'done',
                'schedule': model_to_dict(new_schedule)
            }
            return JsonResponse(response)
        response = {
            'error': 400,
            'message': 'bad input'
        }
        return JsonResponse(response)


def job_portrait(request):
    if request.method == 'POST':
        request_json = json.loads(request.body.decode('utf-8'))
        if 'job_show_name' in request_json:
            hj = HandledJob.objects.filter(job_show_name=request_json['job_show_name']).order_by('job_exp')
            dec_list = {}
            payment_distribution = {'面议': 0, '0-5000': 0, '5000-10000': 0, '10000-25000': 0, '25000-50000': 0,
                                    '50000-80000': 0, '80000+': 0}
            company_size_distribution = {'0-100': 0, '100-800': 0, '800-2000': 0, '2000-8000': 0, '8000-20000': 0,
                                         '20000+': 0}
            edu_demand = {}
            workplaces = {}
            workplace_distribution = {}
            # workplace_distribution = []
            city_info = {10: {'lng': 116.39564503787867, 'lat': 39.92998577808024, 'name': '北京'},
                         23: {'lng': 106.53063501341296, 'lat': 29.54460610888615, 'name': '重庆'},
                         21: {'lng': 121.48789948569473, 'lat': 31.24916171001514, 'name': '上海'},
                         22: {'lng': 117.21081309155257, 'lat': 39.143929903310074, 'name': '天津'},
                         431: {'lng': 125.31364242720072, 'lat': 43.89833760709784, 'name': '长春'},
                         731: {'lng': 112.9793527876505, 'lat': 28.21347823085322, 'name': '长沙'},
                         519: {'lng': 119.98186101345706, 'lat': 31.771396744684242, 'name': '常州'},
                         28: {'lng': 104.06792346330406, 'lat': 30.679942845419564, 'name': '成都'},
                         411: {'lng': 121.59347778143518, 'lat': 38.94870993830429, 'name': '大连'},
                         769: {'lng': 113.76343399075655, 'lat': 23.043023815368237, 'name': '东莞'},
                         757: {'lng': 113.1340256353934, 'lat': 23.035094840514382, 'name': '佛山'},
                         591: {'lng': 119.33022110712668, 'lat': 26.04712549657293, 'name': '福州'},
                         20: {'lng': 113.30764967515182, 'lat': 23.12004910207623, 'name': '广州'},
                         851: {'lng': 106.7091770961758, 'lat': 26.62990674144093, 'name': '贵阳'},
                         451: {'lng': 126.65771685544611, 'lat': 45.7732246332393, 'name': '哈尔滨'},
                         898: {'lng': 110.3308018483363, 'lat': 20.022071276952243, 'name': '海口'},
                         310: {'lng': 114.4826939323422, 'lat': 36.60930792847117, 'name': '邯郸'},
                         571: {'lng': 120.2193754157201, 'lat': 30.259244461536102, 'name': '杭州'},
                         551: {'lng': 117.28269909168304, 'lat': 31.86694226068694, 'name': '合肥'},
                         752: {'lng': 114.41065807997101, 'lat': 23.11353985240842, 'name': '惠州'},
                         391: {'lng': 113.21183588499157, 'lat': 35.234607554985935, 'name': '焦作'},
                         573: {'lng': 120.76042769895746, 'lat': 30.77399223958183, 'name': '嘉兴'},
                         423: {'lng': 126.56454398883335, 'lat': 43.87198833435933, 'name': '吉林'},
                         531: {'lng': 117.02496706629023, 'lat': 36.68278472716141, 'name': '济南'},
                         871: {'lng': 102.71460113878045, 'lat': 25.049153100453157, 'name': '昆明'},
                         931: {'lng': 103.8233054407292, 'lat': 36.06422552504259, 'name': '兰州'},
                         772: {'lng': 109.42240181015114, 'lat': 24.329053352467223, 'name': '柳州'},
                         379: {'lng': 112.44752476895121, 'lat': 34.65736781765111, 'name': '洛阳'},
                         791: {'lng': 115.89352754583604, 'lat': 28.689578000141147, 'name': '南昌'},
                         25: {'lng': 118.77807440802562, 'lat': 32.05723550180587, 'name': '南京'},
                         771: {'lng': 108.29723355586638, 'lat': 22.80649293560261, 'name': '南宁'},
                         513: {'lng': 120.87380095093022, 'lat': 32.014664540823446, 'name': '南通'},
                         574: {'lng': 121.57900597258933, 'lat': 29.885258965918055, 'name': '宁波'},
                         532: {'lng': 120.38442818368189, 'lat': 36.10521490127382, 'name': '青岛'},
                         595: {'lng': 118.60036234322938, 'lat': 24.901652383991102, 'name': '泉州'},
                         24: {'lng': 123.43279092160505, 'lat': 41.808644783515746, 'name': '沈阳'},
                         755: {'lng': 114.0259736573215, 'lat': 22.546053546205247, 'name': '深圳'},
                         311: {'lng': 114.52208184420766, 'lat': 38.048958314615454, 'name': '石家庄'},
                         512: {'lng': 120.61990711548988, 'lat': 31.317987367952437, 'name': '苏州'},
                         576: {'lng': 121.44061293593727, 'lat': 28.668283285674367, 'name': '台州'},
                         315: {'lng': 118.18345059773411, 'lat': 39.6505309225366, 'name': '唐山'},
                         536: {'lng': 119.14263382297052, 'lat': 36.71611487305138, 'name': '潍坊'},
                         631: {'lng': 122.09395836580605, 'lat': 37.52878708125143, 'name': '威海'},
                         27: {'lng': 114.31620010268132, 'lat': 30.58108412692075, 'name': '武汉'},
                         510: {'lng': 120.30545590053595, 'lat': 31.57003745192303, 'name': '无锡'},
                         592: {'lng': 118.10388604566381, 'lat': 24.489230612469232, 'name': '厦门'},
                         29: {'lng': 125.15014857862096, 'lat': 42.98636494637781, 'name': '西安'},
                         374: {'lng': 113.8353124597886, 'lat': 34.026739588655204, 'name': '许昌'},
                         516: {'lng': 117.18810662317686, 'lat': 34.27155343109188, 'name': '徐州'},
                         514: {'lng': 119.42777755116975, 'lat': 32.40850525456844, 'name': '扬州'},
                         535: {'lng': 121.30955503008511, 'lat': 37.53656156285964, 'name': '烟台'},
                         596: {'lng': 117.67620467894616, 'lat': 24.517064779808482, 'name': '漳州'},
                         371: {'lng': 113.64964384986449, 'lat': 34.756610064140254, 'name': '郑州'},
                         760: {'lng': 121.67796628922625, 'lat': 38.900436431991984, 'name': '中山'},
                         756: {'lng': 113.56244702618993, 'lat': 22.25691464612574, 'name': '珠海'},
                         837: {'lng': 102.22856468921427, 'lat': 31.90576285833887, 'name': '阿坝'},
                         997: {'lng': 81.15601314780744, 'lat': 40.349444301112534, 'name': '阿克苏'},
                         483: {'lng': 105.69568287112703, 'lat': 38.84307526440767, 'name': '阿拉善盟'},
                         906: {'lng': 87.9262143601887, 'lat': 47.890135725748884, 'name': '阿勒泰'},
                         897: {'lng': 81.10766868948997, 'lat': 30.404556588325356, 'name': '阿里'},
                         915: {'lng': 109.03804456347515, 'lat': 32.70437044999437, 'name': '安康'},
                         556: {'lng': 117.0587387721073, 'lat': 30.537897817381097, 'name': '安庆'},
                         412: {'lng': 123.0077633288837, 'lat': 41.118743682153465, 'name': '鞍山'},
                         853: {'lng': 105.92826996575766, 'lat': 26.228594577737493, 'name': '安顺'},
                         372: {'lng': 114.35180650767198, 'lat': 36.1102667221811, 'name': '安阳'},
                         436: {'lng': 122.84077667910014, 'lat': 45.621086275218886, 'name': '白城'},
                         776: {'lng': 106.63182140365117, 'lat': 23.901512367910115, 'name': '百色'},
                         439: {'lng': 126.43579767534614, 'lat': 41.94585939701795, 'name': '白山'},
                         943: {'lng': 104.20564932849953, 'lat': 36.501821828710106, 'name': '白银'},
                         552: {'lng': 117.35707986587582, 'lat': 32.92949890669797, 'name': '蚌埠'},
                         312: {'lng': 115.49481016907626, 'lat': 38.88656454802744, 'name': '保定'},
                         917: {'lng': 107.17064545238307, 'lat': 34.36408080974784, 'name': '宝鸡'},
                         875: {'lng': 99.17799561327821, 'lat': 25.120489196190352, 'name': '保山'},
                         472: {'lng': 109.84623853249181, 'lat': 40.64711942570857, 'name': '包头'},
                         478: {'lng': 107.42380671968002, 'lat': 40.76917990242912, 'name': '巴彦淖尔'},
                         996: {'lng': 83.65426222378824, 'lat': 42.60861224235199, 'name': '巴音郭楞'},
                         827: {'lng': 106.75791584175442, 'lat': 31.869189159159983, 'name': '巴中'},
                         779: {'lng': 109.12262791919323, 'lat': 21.472718235009687, 'name': '北海'},
                         414: {'lng': 123.77806236979248, 'lat': 41.32583762664885, 'name': '本溪'},
                         857: {'lng': 105.33332337116845, 'lat': 27.408562131330886, 'name': '毕节'},
                         543: {'lng': 117.96829241452845, 'lat': 37.405313941825895, 'name': '滨州'},
                         909: {'lng': 82.06813945601384, 'lat': 44.90126798918197, 'name': '博尔塔拉'},
                         558: {'lng': 115.78792824511814, 'lat': 33.87121056530193, 'name': '亳州'},
                         317: {'lng': 116.86380647644208, 'lat': 38.297615350325714, 'name': '沧州'},
                         736: {'lng': 111.65371813684197, 'lat': 29.012148855180815, 'name': '常德'},
                         895: {'lng': 96.36244047291781, 'lat': 30.51092480115795, 'name': '昌都'},
                         355: {'lng': 113.12029208572514, 'lat': 36.20166438574343, 'name': '长治'},
                         565: {'lng': 117.88049041703327, 'lat': 31.608732547545824, 'name': '巢湖'},
                         421: {'lng': 116.52169489108084, 'lat': 39.95895316640668, 'name': '朝阳'},
                         768: {'lng': 116.63007599086392, 'lat': 23.661811676516503, 'name': '潮州'},
                         314: {'lng': 117.93382245583847, 'lat': 40.992521052457136, 'name': '承德'},
                         735: {'lng': 113.03770446779562, 'lat': 25.782263975738925, 'name': '郴州'},
                         476: {'lng': 118.9307611921676, 'lat': 42.297112320317325, 'name': '赤峰'},
                         566: {'lng': 117.49447677159357, 'lat': 30.660019248160626, 'name': '池州'},
                         550: {'lng': 118.32457035097686, 'lat': 32.31735059538377, 'name': '滁州'},
                         872: {'lng': 100.21920895421849, 'lat': 25.693966622473024, 'name': '大理'},
                         415: {'lng': 124.33854311476908, 'lat': 40.1290228266375, 'name': '丹东'},
                         459: {'lng': 125.02183973021087, 'lat': 46.596709020007594, 'name': '大庆'},
                         352: {'lng': 124.6990773926766, 'lat': 46.07005100166291, 'name': '大同'},
                         457: {'lng': 124.19610419017351, 'lat': 51.9917889680144, 'name': '大兴安岭'},
                         818: {'lng': 107.49497344658866, 'lat': 31.214198858944734, 'name': '达州'},
                         692: {'lng': 98.58943428740686, 'lat': 24.441239663007963, 'name': '德宏'},
                         838: {'lng': 104.40239781824484, 'lat': 31.131139652701417, 'name': '德阳'},
                         534: {'lng': 116.32816136356094, 'lat': 37.46082592630501, 'name': '德州'},
                         932: {'lng': 104.62663760066474, 'lat': 35.586056241828416, 'name': '定西'},
                         887: {'lng': 99.7136815988831, 'lat': 27.831029461167333, 'name': '迪庆'},
                         546: {'lng': 118.61264305187912, 'lat': 37.408666288041196, 'name': '东营'},
                         477: {'lng': 109.99370625145134, 'lat': 39.81648956060153, 'name': '鄂尔多斯'},
                         718: {'lng': 109.517432662322, 'lat': 30.30897851129638, 'name': '恩施'},
                         711: {'lng': 114.89559404135665, 'lat': 30.384439322752247, 'name': '鄂州'},
                         770: {'lng': 108.35179115286083, 'lat': 21.61739847047181, 'name': '防城港'},
                         413: {'lng': 123.92981976705381, 'lat': 41.8773038295909, 'name': '抚顺'},
                         418: {'lng': 121.66082212856833, 'lat': 42.01925010706022, 'name': '阜新'},
                         794: {'lng': 116.36091886693136, 'lat': 27.954545170269935, 'name': '抚州'},
                         941: {'lng': 102.9174424864958, 'lat': 34.99221117837858, 'name': '甘南'},
                         797: {'lng': 114.9359090792838, 'lat': 25.84529553634676, 'name': '赣州'},
                         836: {'lng': 101.96923206306379, 'lat': 30.055144114355528, 'name': '甘孜'},
                         826: {'lng': 106.75891196362113, 'lat': 30.59924998719945, 'name': '广安'},
                         839: {'lng': 105.81968693999652, 'lat': 32.441040158428244, 'name': '广元'},
                         775: {'lng': 109.61370755657885, 'lat': 23.10337316440881, 'name': '贵港'},
                         773: {'lng': 110.26092014748276, 'lat': 25.262901245955238, 'name': '桂林'},
                         975: {'lng': 100.22372276899289, 'lat': 34.48048458460962, 'name': '果洛'},
                         954: {'lng': 106.28526799598252, 'lat': 36.02152348070926, 'name': '固原'},
                         970: {'lng': 100.8798021744774, 'lat': 36.96065410108381, 'name': '海北'},
                         972: {'lng': 102.37668874251843, 'lat': 36.31274335417832, 'name': '海东'},
                         974: {'lng': 106.92539717866242, 'lat': 39.29620947939178, 'name': '海南'},
                         977: {'lng': 97.34262541533312, 'lat': 37.373799070589904, 'name': '海西'},
                         902: {'lng': 93.52937301238876, 'lat': 42.34446710455244, 'name': '哈密'},
                         916: {'lng': 107.04547762872542, 'lat': 33.08156897815767, 'name': '汉中'},
                         392: {'lng': 114.29776983802476, 'lat': 35.75542587422399, 'name': '鹤壁'},
                         778: {'lng': 108.06994770936778, 'lat': 24.699520782873197, 'name': '河池'},
                         468: {'lng': 130.29247205063453, 'lat': 47.33866590372683, 'name': '鹤岗'},
                         456: {'lng': 127.50083029523519, 'lat': 50.250690090738274, 'name': '黑河'},
                         318: {'lng': 115.68622865290865, 'lat': 37.74692904585666, 'name': '衡水'},
                         734: {'lng': 112.58381881071617, 'lat': 26.89816441535812, 'name': '衡阳'},
                         762: {'lng': 114.71372147587483, 'lat': 23.757250850469006, 'name': '河源'},
                         530: {'lng': 115.46335977452752, 'lat': 35.26244049607468, 'name': '菏泽'},
                         774: {'lng': 111.5525941788367, 'lat': 24.41105354711281, 'name': '贺州'},
                         873: {'lng': 103.3840647571592, 'lat': 23.367717516498995, 'name': '红河'},
                         517: {'lng': 119.31329513263806, 'lat': 33.52834896694177, 'name': '淮安'},
                         561: {'lng': 116.79144742863005, 'lat': 33.96002330536412, 'name': '淮北'},
                         745: {'lng': 109.9869587958539, 'lat': 27.557482901172786, 'name': '怀化'},
                         554: {'lng': 117.01863886329463, 'lat': 32.64281182374795, 'name': '淮南'},
                         713: {'lng': 114.9066180465751, 'lat': 30.446108937901133, 'name': '黄冈'},
                         973: {'lng': 102.00760030834485, 'lat': 35.52285155172832, 'name': '黄南'},
                         559: {'lng': 118.07754612726298, 'lat': 30.277745895120198, 'name': '黄山'},
                         714: {'lng': 115.05068316392396, 'lat': 30.21612712771406, 'name': '黄石'},
                         471: {'lng': 111.6603505200542, 'lat': 40.828318873081585, 'name': '呼和浩特'},
                         429: {'lng': 120.86075764475588, 'lat': 40.743029881317504, 'name': '葫芦岛'},
                         470: {'lng': 119.76082179399947, 'lat': 49.201636054604336, 'name': '呼伦贝尔'},
                         572: {'lng': 120.13724316328172, 'lat': 30.877925155690896, 'name': '湖州'},
                         454: {'lng': 130.28473458595482, 'lat': 46.813779604740354, 'name': '佳木斯'},
                         750: {'lng': 113.07812534115365, 'lat': 22.57511678345104, 'name': '江门'},
                         796: {'lng': 114.99203871092017, 'lat': 27.113847650157084, 'name': '吉安'},
                         937: {'lng': 98.281634585257, 'lat': 39.80239732673353, 'name': '嘉峪关'},
                         663: {'lng': 116.37950085538243, 'lat': 23.547999466926136, 'name': '揭阳'},
                         935: {'lng': 102.20812626259014, 'lat': 38.51607179953174, 'name': '金昌'},
                         356: {'lng': 112.86733275750684, 'lat': 35.49983446722556, 'name': '晋城'},
                         798: {'lng': 117.18652262527252, 'lat': 29.303562768448288, 'name': '景德镇'},
                         724: {'lng': 112.21733029896677, 'lat': 31.04261120294864, 'name': '荆门'},
                         716: {'lng': 112.09985718064648, 'lat': 30.396103360852894, 'name': '荆州'},
                         579: {'lng': 119.65257570368145, 'lat': 29.10289910539069, 'name': '金华'},
                         537: {'lng': 116.60079762482256, 'lat': 35.40212166433135, 'name': '济宁'},
                         354: {'lng': 112.73851439991773, 'lat': 37.69336152679759, 'name': '晋中'},
                         416: {'lng': 121.14774873823639, 'lat': 41.13087887591732, 'name': '锦州'},
                         792: {'lng': 115.99984802155373, 'lat': 29.71963952612237, 'name': '九江'},
                         467: {'lng': 130.94176727325066, 'lat': 45.32153988655108, 'name': '鸡西'},
                         378: {'lng': 114.35164211776365, 'lat': 34.80185417583674, 'name': '开封'},
                         998: {'lng': 76.01434279894337, 'lat': 39.51311058531203, 'name': '喀什地'},
                         990: {'lng': 84.92698963494786, 'lat': 45.20391924603892, 'name': '克拉玛依'},
                         908: {'lng': 76.47212336295175, 'lat': 38.66080913371487, 'name': '克孜勒'},
                         634: {'lng': 117.68466691247161, 'lat': 36.23365413364694, 'name': '莱芜'},
                         316: {'lng': 116.70360222263986, 'lat': 39.51861062508462, 'name': '廊坊'},
                         891: {'lng': 91.11189089598402, 'lat': 29.662557062056536, 'name': '拉萨'},
                         833: {'lng': 103.76082423877176, 'lat': 29.600957611095073, 'name': '乐山'},
                         834: {'lng': 102.25959080320287, 'lat': 27.89239290366571, 'name': '凉山'},
                         518: {'lng': 119.17387221741889, 'lat': 34.60154896700999, 'name': '连云港'},
                         635: {'lng': 115.98686913929107, 'lat': 36.455828514727976, 'name': '聊城'},
                         419: {'lng': 123.17245120514733, 'lat': 41.27333926556943, 'name': '辽阳'},
                         437: {'lng': 125.13368605218399, 'lat': 42.923302619053665, 'name': '辽源'},
                         888: {'lng': 100.22962839887937, 'lat': 26.875351089481363, 'name': '丽江'},
                         883: {'lng': 100.09261291372643, 'lat': 23.887806103773013, 'name': '临沧'},
                         357: {'lng': 111.53878759640808, 'lat': 36.09974544358536, 'name': '临汾'},
                         930: {'lng': 103.20057576109534, 'lat': 35.585834814564286, 'name': '临夏'},
                         539: {'lng': 118.34076823661057, 'lat': 35.07240907439113, 'name': '临沂'},
                         894: {'lng': 95.46623424668277, 'lat': 29.12808019780241, 'name': '林芝'},
                         578: {'lng': 119.92957584318849, 'lat': 28.4562995521443, 'name': '丽水'},
                         564: {'lng': 116.50525268298414, 'lat': 31.75555835519844, 'name': '六安'},
                         858: {'lng': 104.85208676006856, 'lat': 26.59186606031868, 'name': '六盘水'},
                         939: {'lng': 104.9345734057548, 'lat': 33.39447997293795, 'name': '陇南'},
                         597: {'lng': 117.01799673877318, 'lat': 25.07868543351518, 'name': '龙岩'},
                         738: {'lng': 111.99639635657, 'lat': 27.741073302349072, 'name': '娄底'},
                         395: {'lng': 114.04606140022909, 'lat': 33.57627868848315, 'name': '漯河'},
                         830: {'lng': 105.44397028920636, 'lat': 28.895929803860103, 'name': '泸州'},
                         358: {'lng': 111.14315660234801, 'lat': 37.52731609696258, 'name': '吕梁'},
                         555: {'lng': 118.515881846623, 'lat': 31.688528158880025, 'name': '马鞍山'},
                         668: {'lng': 110.93124533067585, 'lat': 21.66822571882161, 'name': '茂名'},
                         753: {'lng': 116.12640309836864, 'lat': 24.30457060603053, 'name': '梅州'},
                         816: {'lng': 104.70551897529307, 'lat': 31.50470125806144, 'name': '绵阳'},
                         453: {'lng': 129.608035395637, 'lat': 44.58852115278252, 'name': '牡丹江'},
                         817: {'lng': 106.10555398379239, 'lat': 30.800965168237234, 'name': '南充'},
                         599: {'lng': 118.18188294866125, 'lat': 26.643626474197838, 'name': '南平'},
                         377: {'lng': 112.5428419005123, 'lat': 33.0114195691165, 'name': '南阳'},
                         896: {'lng': 92.06701836885875, 'lat': 31.480679830119627, 'name': '那曲'},
                         832: {'lng': 105.07305599171474, 'lat': 29.599461534774647, 'name': '内江'},
                         593: {'lng': 119.54208214971854, 'lat': 26.656527419158913, 'name': '宁德'},
                         886: {'lng': 98.85993204248207, 'lat': 25.860676978165355, 'name': '怒江'},
                         427: {'lng': 122.07322781023007, 'lat': 41.14124802295616, 'name': '盘锦'},
                         812: {'lng': 101.72242315249032, 'lat': 26.587571257108653, 'name': '攀枝花'},
                         375: {'lng': 113.30084897797529, 'lat': 33.74530145652439, 'name': '平顶山'},
                         933: {'lng': 106.68891115654719, 'lat': 35.550110190016646, 'name': '平凉'},
                         799: {'lng': 113.85991703300718, 'lat': 27.639544222952306, 'name': '萍乡'},
                         879: {'lng': 100.98005773013449, 'lat': 22.78877778014943, 'name': '普洱'},
                         594: {'lng': 119.07773096395962, 'lat': 25.448450136734262, 'name': '莆田'},
                         393: {'lng': 115.02662744067226, 'lat': 35.75329788820758, 'name': '濮阳'},
                         854: {'lng': 107.52320511005807, 'lat': 26.26453599744225, 'name': '黔南'},
                         859: {'lng': 104.9005577982516, 'lat': 25.095148055926884, 'name': '黔西南'},
                         934: {'lng': 107.6442270867326, 'lat': 35.72680075452996, 'name': '庆阳'},
                         763: {'lng': 113.04077334890835, 'lat': 23.698468550422163, 'name': '清远'},
                         335: {'lng': 119.6043676161184, 'lat': 39.945461565897574, 'name': '秦皇岛'},
                         777: {'lng': 108.6387980564235, 'lat': 21.973350465312727, 'name': '钦州'},
                         452: {'lng': 123.9872889421725, 'lat': 47.34769981336638, 'name': '齐齐哈尔'},
                         464: {'lng': 131.0190480471218, 'lat': 45.77500536864039, 'name': '七台河'},
                         874: {'lng': 103.78253888802674, 'lat': 25.520758142870502, 'name': '曲靖'},
                         570: {'lng': 118.87584165150854, 'lat': 28.95691044753569, 'name': '衢州'},
                         892: {'lng': 88.95606277351817, 'lat': 29.26816003265482, 'name': '日喀则'},
                         633: {'lng': 119.50717994299387, 'lat': 35.42022519314436, 'name': '日照'},
                         398: {'lng': 111.1812620932674, 'lat': 34.783319941049726, 'name': '三门峡'},
                         598: {'lng': 117.64219393404412, 'lat': 26.270835279362192, 'name': '三明'},
                         899: {'lng': 109.52277128135884, 'lat': 18.257775914897483, 'name': '三亚'},
                         914: {'lng': 109.93420815379513, 'lat': 33.87390739508516, 'name': '商洛'},
                         370: {'lng': 115.64188568785016, 'lat': 34.43858864024636, 'name': '商丘'},
                         793: {'lng': 117.95546387714894, 'lat': 28.457622553937274, 'name': '上饶'},
                         893: {'lng': 92.22087273151023, 'lat': 28.35498237810687, 'name': '山南'},
                         754: {'lng': 116.72865028834109, 'lat': 23.383908453269196, 'name': '汕头'},
                         660: {'lng': 115.3729242893998, 'lat': 22.77873050016389, 'name': '汕尾'},
                         751: {'lng': 113.5944611074356, 'lat': 24.80296031189189, 'name': '韶关'},
                         575: {'lng': 120.59246738555154, 'lat': 30.00236458052847, 'name': '绍兴'},
                         739: {'lng': 111.46152540355403, 'lat': 27.236811244922414, 'name': '邵阳'},
                         719: {'lng': 110.80122891676038, 'lat': 32.636994339468124, 'name': '十堰'},
                         952: {'lng': 106.37933720152914, 'lat': 39.02022328360303, 'name': '石嘴山'},
                         469: {'lng': 131.1714017395816, 'lat': 46.65510206248248, 'name': '双鸭山'},
                         349: {'lng': 112.47992772666272, 'lat': 39.33767196622064, 'name': '朔州'},
                         434: {'lng': 124.39138207367984, 'lat': 43.17552470112557, 'name': '四平'},
                         438: {'lng': 124.83299453234117, 'lat': 45.136048970084005, 'name': '松原'},
                         455: {'lng': 126.98909457163498, 'lat': 46.64606392699692, 'name': '绥化'},
                         825: {'lng': 105.56488779226322, 'lat': 30.55749135037996, 'name': '遂宁'},
                         722: {'lng': 113.37935836429192, 'lat': 31.717857608188574, 'name': '随州'},
                         527: {'lng': 118.29689337855334, 'lat': 33.95204973370865, 'name': '宿迁'},
                         557: {'lng': 116.9886924118307, 'lat': 33.63677238578078, 'name': '宿州'},
                         538: {'lng': 117.08941491713698, 'lat': 36.18807775894815, 'name': '泰安'},
                         351: {'lng': 112.5508635890553, 'lat': 37.89027705396754, 'name': '太原'},
                         523: {'lng': 119.91960601619071, 'lat': 32.47605327483028, 'name': '泰州'},
                         938: {'lng': 105.73693162285642, 'lat': 34.58431941886869, 'name': '天水'},
                         410: {'lng': 123.85484961461594, 'lat': 42.29975701212545, 'name': '铁岭'},
                         919: {'lng': 108.96806701340064, 'lat': 34.90836769638356, 'name': '铜川'},
                         435: {'lng': 125.94265013851434, 'lat': 41.73639712986761, 'name': '通化'},
                         475: {'lng': 122.26036326322144, 'lat': 43.633756072995986, 'name': '通辽'},
                         562: {'lng': 117.81942872880637, 'lat': 30.940929694665662, 'name': '铜陵'},
                         856: {'lng': 109.16855802826001, 'lat': 27.674902690624183, 'name': '铜仁'},
                         995: {'lng': 89.26602548864244, 'lat': 42.678924820793675, 'name': '吐鲁番'},
                         913: {'lng': 109.48393269657977, 'lat': 34.5023579758288, 'name': '渭南'},
                         876: {'lng': 104.03093981246279, 'lat': 23.416009535072305, 'name': '文山'},
                         577: {'lng': 120.6906347337091, 'lat': 28.002837594041246, 'name': '温州'},
                         473: {'lng': 106.83199909716231, 'lat': 39.683177006785236, 'name': '乌海'},
                         553: {'lng': 118.38410842322828, 'lat': 31.36601978754301, 'name': '芜湖'},
                         474: {'lng': 113.11284639067514, 'lat': 41.02236294675116, 'name': '乌兰察布'},
                         991: {'lng': 87.56498774111579, 'lat': 43.84038034721766, 'name': '乌鲁木齐'},
                         953: {'lng': 106.20825419850944, 'lat': 37.99356100293566, 'name': '吴忠'},
                         710: {'lng': 112.17632579650555, 'lat': 32.094933645820944, 'name': '襄樊'},
                         732: {'lng': 112.93555563303435, 'lat': 27.83509505297878, 'name': '湘潭'},
                         743: {'lng': 109.74574580039429, 'lat': 28.31795079367364, 'name': '湘西'},
                         715: {'lng': 114.30006059206065, 'lat': 29.88065675772815, 'name': '咸宁'},
                         712: {'lng': 113.93573439207124, 'lat': 30.927954784200963, 'name': '孝感'},
                         479: {'lng': 116.02733968895716, 'lat': 43.93970484232425, 'name': '锡林郭勒盟'},
                         482: {'lng': 122.04816651406564, 'lat': 46.08375706518232, 'name': '兴安盟'},
                         319: {'lng': 114.52048681294414, 'lat': 37.069531196911996, 'name': '邢台'},
                         971: {'lng': 101.76792098980276, 'lat': 36.640738611957964, 'name': '西宁'},
                         373: {'lng': 113.91269016082377, 'lat': 35.3072575576613, 'name': '新乡'},
                         376: {'lng': 114.0854909934702, 'lat': 32.128582307511664, 'name': '信阳'},
                         790: {'lng': 114.9471174167892, 'lat': 27.82232155862896, 'name': '新余'},
                         350: {'lng': 112.72793882880985, 'lat': 38.46103057295889, 'name': '忻州'},
                         691: {'lng': 100.80303827521057, 'lat': 22.00943300223615, 'name': '西双版纳'},
                         563: {'lng': 118.75209631098257, 'lat': 30.951642354295757, 'name': '宣城'},
                         835: {'lng': 103.00935646634746, 'lat': 29.999716337065788, 'name': '雅安'},
                         911: {'lng': 109.50050975696925, 'lat': 36.60332035226031, 'name': '延安'},
                         433: {'lng': 129.4859019581615, 'lat': 42.896413603744136, 'name': '延边'},
                         515: {'lng': 120.14887181793894, 'lat': 33.379861877120995, 'name': '盐城'},
                         662: {'lng': 111.97700975587391, 'lat': 21.87151730451877, 'name': '阳江'},
                         353: {'lng': 113.56923760163296, 'lat': 37.86952949322259, 'name': '阳泉'},
                         831: {'lng': 104.63301906152529, 'lat': 28.76967479626591, 'name': '宜宾'},
                         717: {'lng': 111.31098109196083, 'lat': 30.73275781802591, 'name': '宜昌'},
                         458: {'lng': 128.9005796425911, 'lat': 47.741959238189104, 'name': '伊春'},
                         795: {'lng': 114.40003867155777, 'lat': 27.811129895842885, 'name': '宜春'},
                         999: {'lng': 81.29785353036553, 'lat': 43.922248096340766, 'name': '伊犁哈萨克'},
                         951: {'lng': 106.2064786078384, 'lat': 38.50262101187604, 'name': '银川'},
                         417: {'lng': 122.23339137079269, 'lat': 40.66865106647352, 'name': '营口'},
                         701: {'lng': 117.03545018601243, 'lat': 28.241309597181967, 'name': '鹰潭'},
                         737: {'lng': 112.36654664522563, 'lat': 28.58808777988717, 'name': '益阳'},
                         746: {'lng': 111.61464768615666, 'lat': 26.435971646759207, 'name': '永州'},
                         730: {'lng': 113.14619551911636, 'lat': 29.378007075474304, 'name': '岳阳'},
                         912: {'lng': 109.74592574432862, 'lat': 38.279439240070595, 'name': '榆林'},
                         359: {'lng': 111.00685365308033, 'lat': 35.03885947981193, 'name': '运城'},
                         766: {'lng': 112.05094595864539, 'lat': 22.937975685537467, 'name': '云浮'},
                         976: {'lng': 96.71235011948725, 'lat': 32.90657462992216, 'name': '玉树'},
                         877: {'lng': 102.54506789248256, 'lat': 24.370447134438425, 'name': '玉溪'},
                         623: {'lng': 117.27930538329689, 'lat': 34.80788307838604, 'name': '枣庄'},
                         744: {'lng': 110.4816201569677, 'lat': 29.124889353219793, 'name': '张家界'},
                         313: {'lng': 114.89378153032918, 'lat': 40.81118849110306, 'name': '张家口'},
                         936: {'lng': 100.45989186892419, 'lat': 38.93932029698206, 'name': '张掖'},
                         759: {'lng': 110.36506726285033, 'lat': 21.257463103764316, 'name': '湛江'},
                         758: {'lng': 112.4796533699162, 'lat': 23.078663282928925, 'name': '肇庆'},
                         870: {'lng': 103.72502065573349, 'lat': 27.340632963635457, 'name': '昭通'},
                         511: {'lng': 119.45583540512952, 'lat': 32.20440944359928, 'name': '镇江'},
                         955: {'lng': 105.19675419935521, 'lat': 37.52112419159455, 'name': '中卫'},
                         394: {'lng': 114.65410194229541, 'lat': 33.62374081814082, 'name': '周口'},
                         580: {'lng': 122.1698720983516, 'lat': 30.036010302553937, 'name': '舟山'},
                         396: {'lng': 114.04915354745555, 'lat': 32.98315815409348, 'name': '驻马店'},
                         533: {'lng': 118.05913427786938, 'lat': 36.80468485421204, 'name': '淄博'},
                         813: {'lng': 104.77607133936438, 'lat': 29.359156889475667, 'name': '自贡'},
                         852: {'lng': 106.93126031648453, 'lat': 27.699961377076246, 'name': '遵义'}}
            for job in hj:
                if job.job_min_edu in edu_demand:
                    edu_demand[job.job_min_edu] += 1
                else:
                    edu_demand.update({job.job_min_edu: 1})

                if job.job_workplace in workplaces:
                    workplaces[job.job_workplace] += 1
                else:
                    workplaces.update({job.job_workplace: 1})

                if job.job_pay == 0:
                    payment_distribution['面议'] += 1
                elif 0 < job.job_pay <= 5000:
                    payment_distribution['0-5000'] += 1
                elif 5000 < job.job_pay <= 10000:
                    payment_distribution['5000-10000'] += 1
                elif 10000 < job.job_pay <= 25000:
                    payment_distribution['10000-25000'] += 1
                elif 25000 < job.job_pay <= 50000:
                    payment_distribution['25000-50000'] += 1
                elif 50000 < job.job_pay <= 80000:
                    payment_distribution['50000-80000'] += 1
                elif 80000 < job.job_pay:
                    payment_distribution['80000+'] += 1

                if 0 < job.company_size <= 100:
                    company_size_distribution['0-100'] += 1
                elif 100 < job.company_size <= 800:
                    company_size_distribution['100-800'] += 1
                elif 800 < job.company_size <= 2000:
                    company_size_distribution['800-2000'] += 1
                elif 2000 < job.company_size <= 8000:
                    company_size_distribution['2000-8000'] += 1
                elif 8000 < job.company_size <= 20000:
                    company_size_distribution['8000-20000'] += 1
                elif 20000 < job.company_size:
                    company_size_distribution['20000+'] += 1

                dec = job.job_dec.split(' ')
                for item in dec:
                    if item in dec_list:
                        dec_list[item] += 1
                    else:
                        dec_list.update({item: 1})
                sorted_dec = sorted(dec_list.items(), key=lambda x: x[1], reverse=True)
                i = 0
                dec_words = {}
                for (item, count) in sorted_dec:
                    if i > 10: break
                    dec_words.update({item: count})
                    i += 1
            workplace_distribution_temp = {}
            for zipcode, count in workplaces.items():
                if zipcode in city_info:
                    # item = {
                    #     'name': city_info[zipcode]['name'],
                    #     'lng': city_info[zipcode]['lng'],
                    #     'lat': city_info[zipcode]['lat'],
                    #     'count': count
                    # }
                    # workplace_distribution.append(item)
                    workplace_distribution_temp.update({city_info[zipcode]['name']: count})
            sorted_workplace_distribution = sorted(workplace_distribution_temp.items(), key=lambda x: x[1], reverse=True)
            i = 0
            for item, value in sorted_workplace_distribution:
                if i > 15: break
                workplace_distribution.update({item: value})
                i += 1
            response = {
                'error': 0,
                'job_show_name': request_json['job_show_name'],
                'least_exp': hj[0].job_exp,
                'dec': dec_words,
                'edu_demand_distribution': edu_demand,
                'payment_distribution': payment_distribution,
                'company_size_distribution': company_size_distribution,
                'workplace_distribution': workplace_distribution,
            }
            return JsonResponse(response)
        response = {
            'error': 400,
            'message': 'bad input'
        }
        return JsonResponse(response)


def recommendation(request):
    if request.method == 'POST':
        request_json = json.loads(request.body.decode('utf-8'))
        if 'edu' in request_json \
                and 'workplace' in request_json \
                and 'exp' in request_json \
                and 'skill' in request_json \
                and 'major' in request_json \
                and 'job_show_name' in request_json:
            dec = request_json['skill'] + '+' + request_json['major'] + '+' + request_json['job_show_name']
            hj = HandledJob.objects.filter(job_show_name=request_json['job_show_name'])
            payment_list = []
            edu_list = []
            exp_list = []
            no_edu_demand_count = 0
            for job in hj:
                payment_list.append(job.job_pay)
                exp_list.append(job.job_exp)
                if job.job_min_edu != 0:
                    edu_list.append(job.job_min_edu)
                else:
                    no_edu_demand_count += 1
            recommendations = get_recommend(request_json['edu'], dec, request_json['exp'])
            recommend_jobs = []
            pay_sum = 0
            for recommendation in recommendations:
                recommend_job = {}
                id = recommendation[0]
                job = HandledJob.objects.get(id=id)
                recommend_job['company_name'] = job.company_name
                recommend_job['payment'] = job.job_pay
                pay_sum += job.job_pay
                recommend_job['welfare'] = job.company_welfare
                recommend_job['size'] = job.company_size
                recommend_job['url'] = job.job_url
                recommend_job['rate'] = recommendation[1]
                recommend_jobs.append(recommend_job)
            personal_payment = pay_sum / len(recommendations)
            response = {
                'error': 1,
                'job_show_name': request_json['job_show_name'],
                'payment_range': str(min(payment_list)) + '-' + str(max(payment_list)),
                'personal': {
                    'payment': personal_payment,
                    'edu': request_json['edu'],
                    'exp': request_json['exp'],
                },
                'average': {
                    'payment': sum(payment_list) / float(len(payment_list)),
                    'edu': sum(edu_list) / float(len(edu_list)),
                    'exp': sum(exp_list) / float(len(exp_list)),
                    'no_edu_demand_count': no_edu_demand_count,
                },
                'jobs': recommend_jobs,
            }
            return JsonResponse(response)
        response = {
            'error': 400,
            'message': 'bad input'
        }
        return JsonResponse(response)
